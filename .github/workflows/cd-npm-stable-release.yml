name: NPM Stable Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'NPM version to publish as stable (e.g., 0.0.67)'
        required: true
        type: string
      otp:
        description: '2FA OTP code for NPM publish'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  npm-stable-publish:
    name: Publish NPM Stable Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build release binary
      run: cargo build --release

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'

    - name: Install NPM dependencies
      run: |
        cd npm/terminal-jarvis
        npm install

    - name: Build TypeScript
      run: |
        cd npm/terminal-jarvis
        npm run build

    - name: Lint NPM Package
      run: |
        cd npm/terminal-jarvis
        npm run lint

    - name: Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.X.X (e.g., 0.0.67)"
          exit 1
        fi
        echo "Version format validated: $VERSION"

    - name: Update NPM package version
      run: |
        cd npm/terminal-jarvis
        VERSION="${{ github.event.inputs.version }}"
        npm version $VERSION --no-git-tag-version
        echo "Updated NPM package to version $VERSION"

    - name: Publish to NPM with stable tag
      run: |
        cd npm/terminal-jarvis
        VERSION="${{ github.event.inputs.version }}"
        OTP="${{ github.event.inputs.otp }}"
        
        echo "Publishing terminal-jarvis@$VERSION to NPM..."
        npm publish --otp=$OTP
        
        echo "Adding stable distribution tag..."
        npm dist-tag add terminal-jarvis@$VERSION stable
        
        echo "Verifying distribution tags..."
        npm dist-tag ls terminal-jarvis
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Verify stable release
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "âœ… Successfully published terminal-jarvis@$VERSION with stable tag"
        echo "Users can install with: npm install -g terminal-jarvis@stable"
        echo "Or specific version: npm install -g terminal-jarvis@$VERSION"
        echo ""
        echo "ðŸŽ‰ Production-ready release is now available!"
