name: Continuous Integration

on:

  push:
    branches: [ "main", "develop", "feat/*", "bug/*", "security/*", "hotfix/*" ]
    paths-ignore:
      - '**.md'
      - '.github/skills/**'
      - '.github/copilot-instructions.md'
      - 'LICENSE'

  pull_request:
    branches: [ "main", "develop", "feat/*", "bug/*", "security/*", "hotfix/*" ]
    paths-ignore:
      - '**.md'
      - '.github/skills/**'
      - '.github/copilot-instructions.md'
      - 'LICENSE'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

# Minimal permissions by default; specific jobs can elevate
permissions:
  contents: read

jobs:

  # Test jobs - Rust + NPM suites via matrix
  test:
    name: Test - ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: Rust (Ubuntu)
            suite: rust
            os: ubuntu-latest
          - name: NPM (Node 18)
            suite: npm
            os: ubuntu-latest
            node: 18
          - name: NPM (Node 20)
            suite: npm
            os: ubuntu-latest
            node: 20
    steps:
    - uses: actions/checkout@v5

    # Rust code quality + tests
    - name: Install Rust toolchain
      if: ${{ matrix.suite == 'rust' }}
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo dependencies
      if: ${{ matrix.suite == 'rust' }}
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: cargo-${{ runner.os }}-

    - name: Check formatting
      if: ${{ matrix.suite == 'rust' }}
      run: cargo fmt --all -- --check

    - name: Check clippy
      if: ${{ matrix.suite == 'rust' }}
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Run Rust tests
      if: ${{ matrix.suite == 'rust' }}
      run: cargo test --verbose

    # NPM package tests (build the Rust binary first)
    - name: Install Rust toolchain (for npm build)
      if: ${{ matrix.suite == 'npm' }}
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      if: ${{ matrix.suite == 'npm' }}
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: cargo-${{ runner.os }}-

    - name: Build release binary
      if: ${{ matrix.suite == 'npm' }}
      run: cargo build --release

    - name: Setup Node.js
      if: ${{ matrix.suite == 'npm' }}
      uses: actions/setup-node@v5
      with:
        node-version: ${{ matrix.node }}

    - name: Install dependencies
      if: ${{ matrix.suite == 'npm' }}
      run: |
        cd npm/terminal-jarvis
        npm install

    - name: Build TypeScript
      if: ${{ matrix.suite == 'npm' }}
      run: |
        cd npm/terminal-jarvis
        npm run build

    - name: Lint NPM Package
      if: ${{ matrix.suite == 'npm' }}
      run: |
        cd npm/terminal-jarvis
        npm run lint

    - name: Ensure jq is installed
      if: ${{ matrix.suite == 'npm' }}
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: NPM Audit (high severity)
      if: ${{ matrix.suite == 'npm' }}
      run: |
        cd npm/terminal-jarvis
        npm audit --audit-level=high --json | jq '.' > npm-audit.json || true
        # Fail build if high/critical vulnerabilities are present
        HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json); \
        CRIT=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json); \
        echo "High: $HIGH, Critical: $CRIT"; \
        [ $((HIGH+CRIT)) -eq 0 ]

  # Security - Rust dependency checks (cargo-audit + cargo-deny in one runner)
  security-rust:
    name: Security - Rust
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: cargo-${{ runner.os }}-

    - name: Install dependencies for cargo-audit
      run: sudo apt-get update && sudo apt-get install -y pkg-config libssl-dev

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run cargo-audit
      run: cargo audit --deny warnings --ignore RUSTSEC-2025-0134 --ignore RUSTSEC-2025-0141

    - name: Run cargo-deny checks
      uses: EmbarkStudios/cargo-deny-action@v2
      with:
        command: check advisories bans sources

  # Security - General checks (gitleaks, shellcheck, SBOM - no Rust needed)
  security-general:
    name: Security - General
    permissions:
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    # Allow PRs to surface SBOM findings without blocking; block on main by required checks
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    steps:
    - uses: actions/checkout@v5

    # Gitleaks secrets scan
    - name: Ensure full history for secrets scan
      run: |
        git fetch --prune --unshallow || true

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ShellCheck
    - name: Install ShellCheck
      run: sudo apt-get update && sudo apt-get install -y shellcheck

    - name: Run ShellCheck
      run: |
        set -e
        if [ -d scripts ]; then
          find scripts -type f -name "*.sh" -print0 | xargs -0 -r shellcheck -S style -x
        fi

    # SBOM and vulnerability scan (Anchore)
    - name: Scan workspace with Anchore
      id: anchore
      uses: anchore/scan-action@v4
      with:
        path: .
        fail-build: true
        severity-cutoff: critical
        output-format: sarif

    - name: Upload SARIF to code scanning
      # Upload only on push events and when the SARIF file exists
      if: ${{ always() && github.event_name == 'push' && hashFiles('results.sarif') != '' }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
