{
  "name": "Terminal Jarvis Development",
  "image": "mcr.microsoft.com/devcontainers/base:alpine-3.20",
  
  "features": {
    "ghcr.io/devcontainers/features/rust:1": {
      "version": "latest",
      "profile": "default"
    },
    "ghcr.io/devcontainers/features/node:1": {
      "version": "lts",
      "nodeGypDependencies": true
    },
    "ghcr.io/devcontainers/features/github-cli:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/git:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      "enableNonRootDocker": true
    },
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": true,
      "installOhMyZsh": true,
      "upgradePackages": true,
      "username": "vscode",
      "uid": "1000",
      "gid": "1000"
    }
  },

  "customizations": {
    "vscode": {
      "extensions": [
        "rust-lang.rust-analyzer",
        "vadimcn.vscode-lldb",
        "serayuzgur.crates",
        "tamasfe.even-better-toml",
        "biomejs.biome",
        "ms-vscode.vscode-typescript-next",
        "GitHub.copilot",
        "GitHub.copilot-chat"
      ],
      "settings": {
        "rust-analyzer.cargo.loadOutDirsFromCheck": true,
        "rust-analyzer.procMacro.enable": true,
        "rust-analyzer.checkOnSave.command": "clippy",
        "rust-analyzer.checkOnSave.allTargets": true,
        "rust-analyzer.checkOnSave.allFeatures": true,
        "rust-analyzer.checkOnSave.extraArgs": ["--", "-D", "warnings"],
        "files.watcherExclude": {
          "**/target/**": true
        },
        "search.exclude": {
          "**/target": true,
          "**/Cargo.lock": true
        },
        "editor.formatOnSave": true
      }
    }
  },

  "onCreateCommand": [
    "sh",
    "-c", 
    "echo 'Setting up Alpine development environment...' && apk add --no-cache build-base openssl-dev openssl-libs-static pkgconfig nodejs npm github-cli && echo 'Verifying GitHub CLI installation...' && gh --version && echo 'Alpine development environment ready!'"
  ],

  "postCreateCommand": [
    "sh", 
    "-c",
    "echo 'Building project dependencies...' && source ~/.cargo/env && cargo check --all-targets && echo 'Installing NPM dependencies...' && cd npm/terminal-jarvis && npm install && cd ../.. && echo 'Verifying installation...' && rustc --version && cargo --version && node --version && npm --version && echo '\nðŸš€ Terminal Jarvis development environment ready!' && echo 'Quick commands:' && echo '  source ~/.cargo/env      # Load Rust environment' && echo '  cargo run -- --help     # Show Terminal Jarvis help' && echo '  cargo run -- list       # List available AI tools' && echo '  cargo test              # Run all tests'"
  ],

  "postStartCommand": [
    "sh",
    "-c",
    "echo 'source ~/.cargo/env' >> ~/.bashrc && echo '# Terminal Jarvis Custom Prompt' >> ~/.bashrc && echo 'parse_git_branch() { git branch 2>/dev/null | sed -e \"/^[^*]/d\" -e \"s/* \\(.*\\)/\\1/\"; }' >> ~/.bashrc && echo 'export PS1=\"\\[\\033[1;36m\\]terminal-jarvis\\[\\033[0m\\]:\\[\\033[1;34m\\]\\w\\[\\033[0m\\] \\[\\033[1;32m\\](\\$(parse_git_branch))\\[\\033[0m\\] \\[\\033[1;35m\\]âž¤\\[\\033[0m\\] \"' >> ~/.bashrc && echo 'Welcome to Terminal Jarvis development!' && echo 'Environment: Alpine Linux with Rust toolchain' && echo 'All dependencies installed and configured!' && echo '' && echo 'Quick start commands:' && echo '  cargo run -- --help     # Show Terminal Jarvis help' && echo '  cargo run -- list       # List AI tools' && echo '  cargo test              # Run tests' && echo '  ./scripts/cicd/local-ci.sh # Run CI checks' && echo '' && echo 'Rust environment is automatically loaded!' && echo 'Custom colorful prompt configured!'"
  ],

  "remoteUser": "vscode",
  
  "mounts": [
    "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind"
  ],

  "forwardPorts": [3000, 8000, 8080],
  "portsAttributes": {
    "3000": {
      "label": "Development Server",
      "onAutoForward": "silent"
    },
    "8000": {
      "label": "Local File Server",
      "onAutoForward": "silent"
    },
    "8080": {
      "label": "Alternative Server",
      "onAutoForward": "silent"
    }
  },

  "containerEnv": {
    "RUST_LOG": "debug",
    "CARGO_TERM_COLOR": "always",
    "CARGO_INCREMENTAL": "1",
    "RUST_BACKTRACE": "1",
    "PATH": "/home/vscode/.cargo/bin:${PATH}",
    "CARGO_HOME": "/home/vscode/.cargo",
    "RUSTUP_HOME": "/home/vscode/.rustup",
    "HOME": "/home/vscode",
    "USER": "vscode"
  },

  "shutdownAction": "stopContainer",
  
  "waitFor": "postCreateCommand"
}
